<template>
  <div class="query-form"
       :class="`query-form-${timeStamp}`">
    <el-form :model="model"
             ref="validateForm"
             size="mini"
             :label-width="returnLabelWidth()"
             label-position="right">
      <template v-for="(item, index) in formFields">
        <form-item v-if="item.show === undefined ? true : item.show"
                   :item="item"
                   class="query-form-item"
                   :class="item.columnName==='startTime'?'daterange':''"
                   v-model="model[item.columnName]"
                   :key="index">
        </form-item>
      </template>
      <el-form-item class="query-form-btns">
        <div class="btn-item"
             v-if="showSubmit">
          <el-button class="blue-solid-btn submit"
                     type="primary"
                     size="mini"
                     icon="el-icon-search"
                     @click="onSubmit">查询</el-button>
        </div>
        <div class="btn-item"
             v-if="showReset">
          <el-button class="blue-hollow-btn reset"
                     size="mini"
                     @click="onReset"
                     icon="el-icon-refresh-right">重置</el-button>
        </div>
        <div v-if="tools && tools.length > 0"
             class="add-btns">
          <slot></slot>
          <asp-tool-list class="asp-tool-list"
                         v-if="tools && tools.length > 0"
                         :toolList="tools"></asp-tool-list>
        </div>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
import formItem from './form-item'
export default {
  name: 'query-form',
  props: {
    formFields: {
      type: Array,
      default: () => []
    },
    tools: {
      type: Array,
      default: () => []
    },
    showReset: {
      type: Boolean,
      default: () => true
    },
    labelWidth: {
      type: [String, Number]
    },
    showSubmit: {
      type: Boolean,
      default: () => true
    },
    timeStamp: [String, Number]
  },
  data () {
    return {
      model: {}
    }
  },
  created () {
    this.$nextTick(() => {
      this.createModel()
    })
  },
  components: {
    formItem
  },
  methods: {
    onSubmit () {
      this.$refs['validateForm'].validate((valid) => {
        if (valid) {
          console.log('submit!')
          console.log(this.model)
          this.$emit('formSubmit', this.model)
        } else {
          console.log('error submit!!')
          return false
        }
      })
    },
    onReset () {
      this.createModel()
      this.$emit('reset', this.model)
    },
    getModel () {
      return this.model
    },
    resetModel () {
      this.$nextTick(() => {
        this.createModel()
      })
    },
    createModel () {
      const ARRAY_ITEM = ['datetimerange', 'daterange']
      const RADIO_ITEM = ['radioGroup', 'selectRadio']
      this.formFields.forEach((item) => {
        if (item.show === undefined || item.show) {
          if (ARRAY_ITEM.indexOf(item.type) >= 0 || item.multiple) {
            this.$set(this.model, item.columnName, item.defaultValue || [])
          } else if (item.type === 'selectTree') {
            // console.log(item)
            if (item.defaultKeysType === 'lazy') {
              // 懒加载只通过设置key无法改变label 手动变动defaultkeys数组 通过init变动label
              if (item.defaultCheckedKeys.length >= 3) {
                item.defaultCheckedKeys.splice(2)
              } else {
                item.defaultCheckedKeys.push(new Date().getTime())
              }
              setTimeout(() => {
                this.$set(this.model, item.columnName, item.defaultCheckedKeys[1])
              }, 0)
            } else {
              this.$set(this.model, item.columnName, item.defaultCheckedKeys || [])
            }
            // console.log(item.defaultCheckedKeys, ' selectTree ')
          } else if (RADIO_ITEM.indexOf(item.type) >= 0) {
            if (item.type === 'radioGroup') {
              item.value = item.defaultValue || null
            }
            this.$set(this.model, item.columnName, item.defaultValue || item.defaultValue === 0 ? item.defaultValue : '')
          } else {
            this.$set(this.model, item.columnName, item.defaultValue || item.defaultValue === 0 ? item.defaultValue : '')
          }
        }
      })
    },
    setValue (columnName, value) {
      this.$set(this.model, columnName, value)
    },
    setOptions (columnName, options) {
      this.formFields.forEach(item => {
        if (item.columnName === columnName) {
          console.log(item)
          item.options = options
        }
      })
    },
    setDisabled (columnName, state) {
      this.formFields.forEach((item, index) => {
        if (item.columnName === columnName) {
          this.$set(this.formFields[index], 'disabled', state)
        }
      })
    },
    setFormField (columnName, key, value) {
      this.formFields.forEach((item, index) => {
        if (item.columnName === columnName) {
          this.$set(this.formFields[index], key, value)
        }
      })
    },
    // 动态计算表单label宽度
    returnLabelWidth (item) {
      if (this.labelWidth) {
        return this.labelWidth
      }
      if (this.formFields && this.formFields.length > 0) {
        let max = this.formFields[0]
        this.formFields.forEach(cell => {
          if (cell.label.length > max.label.length && (cell.show === undefined || cell.show)) {
            max = cell
          }
        })
        // console.log(max)
        const length = max.label.replace(/[^\x00-\xff]/g, '*').length
        let num = Number(14 * length) + 23
        return num + 'px'
      }
    }
  }
}
</script>
<style scoped lang="scss">
.query-form {
  /deep/ .el-form {
    .el-form-item__label {
      // width: auto !important;
      padding-right: 8px;
    }
    .query-form-btns {
      margin-right: 0 !important;
      float: right;
      display: inline-block;
      .el-form-item__content {
        display: flex;
        flex-direction: row;
        text-align: right;
        margin-left: 0 !important;
        .btn-item {
          flex: 1;
          flex-basis: auto;
          margin-left: 10px;
        }
        .add-btns {
          margin-left: 10px;
        }
      }
    }
  }
}
/deep/ .el-form-item {
  // margin-right: 8px !important;
  margin-bottom: 12px !important;
  .el-form-item__label {
    padding-right: 5px;
  }
  &.query-form-item {
    .el-form-item__content {
      > div {
        width: 100%;
      }
      // > .el-range-editor {
      //   width: 400px;
      // }
    }
  }
}
</style>
