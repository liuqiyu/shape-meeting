<template>
  <div class="query-table"
       :class="`query-table-${timeStamp}`"
       id="query-table">
    <query-form class="query-form"
                ref="queryForm"
                :showReset="showReset"
                :showSubmit="showSubmit"
                :timeStamp="timeStamp"
                :labelWidth="labelWidth"
                :tools="formTools"
                v-if="formFields.length > 0"
                :form-fields="formFields"
                @formSubmit="formSubmit"
                @reset="reset">
      <!-- <slot name="query-form-buttons"></slot> -->
    </query-form>

    <!-- 分割线 -->
    <div v-if="formFields.length > 0"
         class="query-table-divider"></div>

    <div class="middle-tools">
      <slot name="middle-tools"></slot>
    </div>

    <asp-tool-list class="asp-tool-list"
                   v-if="tools && tools.length > 0"
                   :toolList="tools"></asp-tool-list>

    <table-list v-loading="loading"
                class="table-list"
                ref="tableList"
                :timeStamp="timeStamp"
                :columns="tables.columns"
                :operation="tables.operation"
                :options="tables.options"
                :tableData="tableData"
                :changeTableData="changeTableData"
                :tableDataTemp="tableDataTemp"
                :dropColumns="tables.dropColumns"
                @sortChange="sortChange">
      <div slot="expand"
           slot-scope="{ data }">
        <slot name="expand"
              :data="data"></slot>
      </div>
    </table-list>

    <div class="asp-pagination"
         :class="`asp-pagination-${timeStamp}`"
         v-if="tables.options.page">
      <el-pagination background
                     @size-change="handleSizeChange"
                     @current-change="handleCurrentChange"
                     :current-page.sync="currentPage"
                     :page-sizes="tables.url.pageSizes || [15,30,50]"
                     :page-size="pageSize"
                     layout="total, sizes, prev, pager, next, jumper"
                     :total="total"></el-pagination>
      <span class="count-detail"
            v-if="tables.options.showCountIcon">
        <el-popover placement="right"
                    width="270"
                    trigger="click">
          <div class="popover-content">{{tables.options.countDetail}}</div>
          <i slot="reference"
             class="iconfont"
             :class="tables.options.iconClass||'iconwenjian'"></i>
        </el-popover>
      </span>
    </div>

    <slot name="bottom-tools"></slot>
  </div>
</template>

<script>
import moment from 'moment'
import { deepClone } from '@/utils'
import Sortable from 'sortablejs'
export default {
  name: 'query-table',
  props: {
    option: {
      type: Object,
      default: () => { }
    },
    tools: {
      type: Array,
      default: () => []
    },
    formFields: {
      type: Array,
      default: () => []
    },
    formTools: {
      type: Array,
      default: () => []
    },
    tables: {
      type: Object,
      default: () => { }
    },
    labelWidth: {
      type: [String, Number]
    },
    showReset: {
      type: Boolean,
      default: () => true
    },
    showSubmit: {
      type: Boolean,
      default: () => true
    }
  },
  data () {
    return {
      loading: false,
      tableData: [],
      tableDataTemp: [],
      currentPage: 1,
      pageSize: 15,
      total: 0,
      queryModel: {},
      timeStamp: '',
      changeTableData: {},
      resData: {}
    }
  },
  mounted () {
    if (this.tables.options.initHttp || this.tables.options.initHttp === undefined) {
      this.$nextTick(() => {
        if (this.formFields.length > 0) {
          this.queryModel = Object.assign(
            {},
            this.queryModel,
            this.$refs.queryForm.getModel()
          )
        }
        this.fetchTable(this.queryModel)
      })
    }
    this.timeStamp = moment(new Date()).valueOf()
    if (this.tables.options && this.tables.options.draggable) {
      this.$nextTick(() => {
        // 防止火狐在拖拽时打开新页面
        document.body.ondrop = function (event) {
          event.preventDefault()
          event.stopPropagation()
        }
        let hidenItems = document.querySelector('.el-table__header-wrapper tr .gutter')
        if (hidenItems) hidenItems.parentNode.removeChild(hidenItems)
        this.columnDrop()
      })
    }
  },
  methods: {
    initTables (callback) {
      this.fetchTable(this.queryModel, callback)
    },
    loadTable (model = {}, callback) {
      this.currentPage = model.currentPage ? this.currentPage : 1
      this.queryModel = Object.assign({}, this.queryModel, model)
      this.fetchTable(this.queryModel, callback)
    },

    setQueryFormOptions (columnName, options) {
      this.$refs.queryForm.setOptions(columnName, options)
    },
    setQueryFormDisabled (columnName, state) {
      this.$refs.queryForm.setDisabled(columnName, state)
    },
    setQueryFormValue (columnName, state) {
      this.$refs.queryForm.setValue(columnName, state)
    },
    /**
     * 搜索
     * @param model 如果为undefined 则不是查询事件。如果有值，则为翻页等等操作。
     */
    formSubmit (model) {
      if (model) {
        this.currentPage = model.currentPage ? this.currentPage : 1
        this.queryModel = Object.assign({}, this.queryModel, model)
        this.fetchTable(this.queryModel)
      } else {
        this.fetchTable(this.queryModel)
      }
    },
    reset (model) {
      console.log(model)
      this.$emit('reset', model)
    },
    async fetchTable (model = {}, callback) {
      try {
        this.loading = this.tables.options.loading === undefined ? true : this.tables.options.loading
        const obj = this.tables.url.obj || {}
        if (model.order === null) {
          delete model.order
          delete model.prop
        }

        let params = {}

        if (this.tables.options.page || this.tables.options.page === undefined) {
          this.pageSize = this.tables.url.pageSize || this.pageSize
          // 为了匹配后端同学字段未统一问题：可自定义字段

          if (this.tables.url.pageSet && this.tables.url.pageSet.length > 0) {
            params[this.tables.url.pageSet[0]] = this.currentPage
            params[this.tables.url.pageSet[1]] = this.pageSize
          } else {
            params.page_no = this.currentPage
            params.page_size = this.pageSize
          }
        }

        params = {
          ...params,
          ...obj,
          ...model
        }
        if (
          this.tables.options &&
          typeof this.tables.options.beforeHttp === 'function'
        ) {
          this.tables.options.beforeHttp(params)
        }
        let data

        try {
          data = await this.$http.sendRequest({
            method: this.tables.url.type || 'POST',
            url: this.tables.url.method,
            data: this.tables.url.type === 'POST' ? params : {},
            params: (this.tables.url.type === 'GET' || this.tables.url.setUrl) ? params : {},
            addNamespace:
              this.tables.url.addNamespace === undefined
                ? this.tables.url.addNamespace
                : null
          })
          this.total = data.count || 0
          this.resData = data
        } catch (e) {
          console.log(e)
        }

        // perf(兼容处理)：数据处理前，处理返回数据
        if (this.tables.options && typeof this.tables.options.httpDataHandle === 'function') {
          this.tables.options.httpDataHandle(data)
          // 定时刷新时判断数据是否有更新进行截止
          if (this.tables.options.stop) return
        }

        if (!data.result) {
          this.tableData = []
          this.tableDataTemp = []
          this.changeTableData = {}
          this.loading = false
          return false
        }
        this.tableData = data.result
        this.tableDataTemp = deepClone(data.result)
        this.changeTableData = {}

        // 请求成功后回调函数
        if (
          this.tables.options &&
          typeof this.tables.options.afterHttp === 'function'
        ) {
          this.tables.options.afterHttp(this.tableData, data)
        }

        if (this.tables.options.pageType === 'static') {
          this.tableData = this.tableDataTemp.slice((this.currentPage - 1) * this.pageSize, this.currentPage * this.pageSize)
          this.total = this.tableDataTemp.length || 0
        }

        // if (this.tables.options && typeof this.tables.options.asyncHttp === 'function') {
        //   const res = await this.tables.options.asyncAfterHttp(this.tableData, data)
        //   this.tableData = res
        // }
        this.formatter()

        if (
          this.tables.options &&
          typeof this.tables.options.lastHttp === 'function'
        ) {
          this.tables.options.lastHttp(this.tableData, data)
        }
        // last
        if (this.tables.options && typeof this.tables.options.asyncAfterHttp === 'function') {
          const res = await this.tables.options.asyncAfterHttp(
            this.tableData,
            data
          )
          this.tableData = res
          this.tableDataTemp = deepClone(res)
        }
        // 为了解决异步队列问题
        if (callback) {
          callback(this.tableData)
        }
        this.loading = false
      } catch (e) {
        console.log(e)
        this.loading = false
      }
    },
    formatter () {
      this.tableData.forEach((item, index) => {
        this.$set(this.tableData[index], 'index', (this.currentPage - 1) * this.pageSize + (1 + index)
        )
        this.$set(this.tableData[index], 'isEdit', false)
        if (this.tables.options.editor) {
          this.$set(this.tableData[index], 'isEdit', true)
        }
        // 自定义列表输出文字
        if (
          this.tables.formatter &&
          Object.keys(this.tables.formatter).length > 0
        ) {
          Object.keys(this.tables.formatter).forEach(key => {
            if (Object.keys(item).indexOf(key)) {
              this.$set(
                this.tableData[index],
                key,
                this.tables.formatter[key](item)
              )
            }
          })
        }
      })
    },
    // 设置表格数据
    setTableData (data) {
      this.currentPage = 1
      this.tableData = data
      this.tableDataTemp = deepClone(data)

      if (this.tables.options.pageType === 'static') {
        this.tableData = this.tableDataTemp.slice((this.currentPage - 1) * this.pageSize, this.currentPage * this.pageSize)
        this.total = data.length || 0
      }
      this.formatter()
    },
    // 获取表格数据
    getTableData () {
      return this.tableData
    },
    // 页码
    handleSizeChange (val) {
      const _this = this
      if (this.tables.options.sizeChange && typeof this.tables.options.sizeChange === 'function') {
        this.tables.options.sizeChange(this.changeTableData, next)
      } else {
        this.handleSizeChangeNext(val)
      }

      function next (state) {
        if (state === undefined || state) {
          _this.handleSizeChangeNext(val)
        }
      }

      if (this.tables.options.pageType === 'static') {
        this.tableData = this.tableDataTemp.slice((this.currentPage - 1) * this.pageSize, this.currentPage * this.pageSize)
        this.formatter()
      }
    },
    handleSizeChangeNext (val) {
      this.pageSize = val
      if (this.tables.url.pageSize) this.tables.url.pageSize = val
      this.formSubmit()
    },
    // 翻页
    handleCurrentChange (val) {
      if (this.tables.options.pageType === 'static') {
        this.tableData = this.tableDataTemp.slice((this.currentPage - 1) * this.pageSize, this.currentPage * this.pageSize)
        this.formatter()
        return
      }

      const _this = this
      if (this.tables.options.currentChange && typeof this.tables.options.currentChange === 'function') {
        this.tables.options.currentChange(this.changeTableData, next)
      } else {
        this.handleCurrentChangeNext(val)
      }
      if (this.tables.options.afterCurrentChange && typeof this.tables.options.afterCurrentChange === 'function') {
        this.tables.options.afterCurrentChange()
      }
      function next (state) {
        if (state === undefined || state) {
          _this.handleCurrentChangeNext(val)
        }
      }
    },
    handleCurrentChangeNext (val) {
      this.currentPage = val
      this.formSubmit()
    },
    sortChange (val) {
      try {
        if (!this.tables.options.sortDefault) this.formSubmit(val)
      } catch (e) {

      }
    },
    // 清空queryFrom值
    resetQueryFrom () {
      this.$refs.queryForm.onReset()
    },
    setTableColumn (key, keys, value) {
      this.tables.columns.forEach((item, i) => {
        if (item.key === key) {
          this.$set(this.tables.columns[i], keys, value)
        }
      })
    },
    setTableEdit (state) {
      this.tableData.forEach(item => {
        item.isEdit = state
      })
      this.$set(this.tables.options, 'editor', state)
    },
    setTableOperationShow (state) {
      this.$set(this.tables.operation, 'show', state)
    },
    validateTableForm (success, error) {
      this.$refs.tableList.validateTableForm(success, error)
    },
    // 列拖拽
    columnDrop () {
      const wrapperTr = document.querySelector('.el-table__header-wrapper tr')
      Sortable.create(wrapperTr, {
        animation: 150,
        delay: 0,
        onEnd: ({ newIndex, oldIndex }) => {
          let leftArr = ['radio', 'selection']
          if ((this.tables.options.type && leftArr.includes(this.tables.options.type)) || this.tables.options.index === undefined || this.tables.options.index) {
            oldIndex = oldIndex - 1
            newIndex = newIndex - 1
          }
          // 显示的列
          let showColumns = this.tables.columns.filter(item => item.show === undefined || item.show)
          let realOldIndex = this.tables.columns.findIndex(item => item.key === showColumns[oldIndex].key)
          let realNewIndex = this.tables.columns.findIndex(item => item.key === showColumns[newIndex].key)
          const oldItem = this.tables.dropColumns[realOldIndex]
          this.tables.dropColumns.splice(realOldIndex, 1)
          this.tables.dropColumns.splice(realNewIndex, 0, oldItem)
          if (this.tables.options.draggableFunc) this.tables.options.draggableFunc(newIndex, oldIndex)
        }
      })
    }
  }
}
</script>

<style lang="scss">
.query-table {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  .query-form,
  .middle-tools,
  .asp-tool-list,
  .asp-pagination {
    flex: none;
  }
  .table-list {
    flex: 1;
    height: 10%;
  }
  .query-table-divider {
    height: 1px;
    background: rgba(229, 229, 229, 1);
    width: 100%;
    margin-bottom: 12px;
  }
}
</style>
